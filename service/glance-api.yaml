service:
  name: glance-api
  ports:
    - {{ glance_api_port }}
  containers:
    - name: glance-api
      image: glance-api
      # TODO(sreshetniak): add probes
      probes:
        readiness: "true"
        liveness: "true"
      pre:
        - name: glance-db-create
          dependencies:
            - mariadb
          type: single
          command:
            mysql -u root -p{{ db_root_password }} -h mariadb -e "create database {{ glance_db_name }};
            grant all privileges on {{ glance_db_name }}.* to '{{ glance_db_username }}'@'%' identified by '{{ glance_db_password }}';"
        - name: glance-db-sync
          files:
            - glance-api
          dependencies:
            - glance-db-create
          type: single
          command: glance-manage db_sync
        - name: glance-user-create
          dependencies:
            - keystone
          type: single
          command: openstack user create --domain default --password {{ glance_password  }} {{ glance_user }}
        - name: glance-role-add
          dependencies:
            - glance-user-create
          type: single
          command: openstack role add --project {{ openstack_project_name }} --user {{ glance_user }} admin
        - name: glance-service-create
          dependencies:
            - keystone
          type: single
          command: openstack service create --name glance --description "OpenStack Image service" image
        - name: glance-public-endpoint-create
          dependencies:
            - glance-service-create
          type: single
          command: openstack endpoint create --region RegionOne image public http://{{ address('glance-api') }}:{{ glance_api_port }}
        - name: glance-internal-endpoint-create
          dependencies:
            - glance-service-create
          type: single
          command: openstack endpoint create --region RegionOne image internal http://{{ address('glance-api') }}:{{ glance_api_port }}
        - name: glance-admin-endpoint-create
          dependencies:
            - glance-service-create
          type: single
          command: openstack endpoint create --region RegionOne image admin http://{{ address('glance-api') }}:{{ glance_api_port }}
      daemon:
        files:
          - glance-api
        command: glance-api

files:
  glance-api:
    path: /etc/glance/glance-api.conf
    content: glance-api.conf.j2
