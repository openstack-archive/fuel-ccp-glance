dsl_version: 0.4.0
service:
  name: glance-registry
  ports:
    - {{ glance.registry_port }}
  annotations:
    service:
      prometheus.io/probe: "true"
      prometheus.io/probe_path: "/healthcheck"
  containers:
    - name: glance-registry
      image: glance-registry
      daemon:
        files:
          - glance-registry-conf
          # {% if glance.tls.enabled %}
          - ca_cert
          # {% endif %}
        dependencies:
          - glance-api
        command: glance-registry
    # {% if glance.tls.enabled %}
    - name: nginx-registry
      image: nginx
      daemon:
        files:
          - upstreams
          - servers
          - server-cert
          - server-key
        command: nginx
    # {% endif %}

files:
  glance-registry-conf:
    path: /etc/glance/glance-registry.conf
    content: glance-registry.conf.j2
  # {% if glance.tls.enabled %}
  servers:
    path: /etc/nginx/conf.d/servers.conf
    content: nginx-registry.conf.j2
    perm: "0400"
  upstreams:
    path: /etc/nginx/conf.d/upstreams.conf
    content: upstreams.conf.j2
    perm: "0400"
  ca_cert:
    path: /opt/ccp/etc/tls/ca.pem
    content: ca-cert.pem.j2
  server-cert:
    path: /opt/ccp/etc/tls/server-cert.pem
    content: server-cert.pem.j2
    perm: "0400"
  server-key:
    path: /opt/ccp/etc/tls/server-key.pem
    content: server-key.pem.j2
    perm: "0400"
  # {% endif %}
